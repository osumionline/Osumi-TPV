<div class="ventas-select-date">
    <div class="form-field">
        <label>Mes</label>
        <mat-form-field>
            <mat-select [(ngModel)]="ventasMonth"
                        [ngModelOptions]="{standalone: true}"
                        (ngModelChange)="searchVentasCliente()">
                @for (month of monthList; track month.id) {
                <mat-option [value]="month.id">
                    {{month.name}}
                </mat-option>
                }
            </mat-select>
        </mat-form-field>
    </div>
    <div class="form-field">
        <label>Año</label>
        <mat-form-field>
            <mat-select [(ngModel)]="ventasYear"
                        [ngModelOptions]="{standalone: true}"
                        (ngModelChange)="searchVentasCliente()">
                @for (year of yearList; track year) {
                <mat-option [value]="year">
                    {{year}}
                </mat-option>
                }
            </mat-select>
        </mat-form-field>
    </div>
</div>
<table mat-table
       [dataSource]="ventasDataSource"
       class="mat-elevation-z2 ">

    <!-- Fecha -->
    <ng-container matColumnDef="fecha">
        <th mat-header-cell
            *matHeaderCellDef>
            Fecha
        </th>
        <td mat-cell
            *matCellDef="let element"> {{element.fecha}} </td>
    </ng-container>

    <!-- Importe -->
    <ng-container matColumnDef="total">
        <th class="right"
            mat-header-cell
            *matHeaderCellDef>
            Importe
        </th>
        <td class="right"
            mat-cell
            *matCellDef="let element"> {{element.total | fixedNumber}} €</td>
    </ng-container>

    <!-- Tipo de pago -->
    <ng-container matColumnDef="nombreTipoPago">
        <th class="center"
            mat-header-cell
            *matHeaderCellDef>
            Tipo de pago
        </th>
        <td mat-cell
            *matCellDef="let element"
            class="center">
            {{element.nombreTipoPago}}
        </td>
    </ng-container>

    <!-- Tipo de pago -->
    <ng-container matColumnDef="options">
        <th class="center"
            mat-header-cell
            *matHeaderCellDef>
            Opciones
        </th>
        <td class="center"
            mat-cell
            *matCellDef="let element">
            <button mat-icon-button
                    matTooltip="Imprimir ticket"
                    type="button"
                    (click)="printTicket($event, element)">
                <mat-icon>receipt</mat-icon>
            </button>
            <button mat-icon-button
                    matTooltip="Enviar ticket por email"
                    type="button"
                    (click)="enviarEmail($event, element)">
                <mat-icon>email</mat-icon>
            </button>
        </td>
    </ng-container>

    <tr mat-header-row
        *matHeaderRowDef="ventasDisplayedColumns"></tr>
    <tr class="clickable"
        mat-row
        [class]="{'selected-row': ventaSelected !== null && row.id === ventaSelected.id}"
        (click)="selectVenta(i)"
        *matRowDef="let row; columns: ventasDisplayedColumns; let i = index;"></tr>
</table>

@if (ventaSelected !== null) {
<div class="venta-detail-lineas">
    <table mat-table
           [dataSource]="ventaSelectedDataSource"
           matSort
           class="mat-elevation-z2 ">

        <!-- Localizador -->
        <ng-container matColumnDef="localizador">
            <th mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                sortActionDescription="Ordenar por localizador">
                Localizador
            </th>
            <td mat-cell
                *matCellDef="let element"> {{ element.idArticulo !== null ? element.localizador : '-' }} </td>
            <td mat-footer-cell
                *matFooterCellDef> <strong>Total</strong> </td>
        </ng-container>

        <!-- Marca -->
        <ng-container matColumnDef="marca">
            <th mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                sortActionDescription="Ordenar por marca">
                Marca
            </th>
            <td mat-cell
                *matCellDef="let element"> {{ element.idArticulo !== null ? element.marca : '-' }} </td>
            <td mat-footer-cell
                *matFooterCellDef></td>
        </ng-container>

        <!-- Descripción -->
        <ng-container matColumnDef="articulo">
            <th mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                sortActionDescription="Ordenar por descripcion">
                Descripción
            </th>
            <td mat-cell
                *matCellDef="let element"> {{element.articulo}} </td>
            <td mat-footer-cell
                *matFooterCellDef></td>
        </ng-container>

        <!-- Cantidad -->
        <ng-container matColumnDef="unidades">
            <th class="center"
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                sortActionDescription="Ordenar por cantidad">
                Cant.
            </th>
            <td class="center"
                mat-cell
                *matCellDef="let element"> {{element.unidades}} </td>
            <td class="center"
                mat-footer-cell
                *matFooterCellDef> <strong>{{ventaSelected.totalUnidades}}</strong> </td>
        </ng-container>

        <!-- PVP -->
        <ng-container matColumnDef="pvp">
            <th class="center"
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                sortActionDescription="Ordenar por PVP">
                PVP
            </th>
            <td class="center"
                mat-cell
                *matCellDef="let element"> {{element.pvp | fixedNumber}} € </td>
            <td class="center"
                mat-footer-cell
                *matFooterCellDef></td>
        </ng-container>

        <!-- Descuento -->
        <ng-container matColumnDef="descuento">
            <th class="center"
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                sortActionDescription="Ordenar por descuento">
                Desc.
            </th>
            <td class="center"
                mat-cell
                *matCellDef="let element">
                @if (element.importeDescuento) {
                <span>{{element.importeDescuento | fixedNumber}} €</span>
                }
                @if (!element.importeDescuento && element.descuento !== 0) {
                <span>{{element.descuento}} %</span>
                }
                @if (!element.importeDescuento && element.descuento === 0) {
                <span>-</span>
                }
                @if (element.regalo) {
                <mat-icon class="icon">loyalty</mat-icon>
                }
            </td>
            <td class="center"
                mat-footer-cell
                *matFooterCellDef>
                @if (ventaSelected.totalDescuento !== 0) {
                <div>
                    <strong>{{ventaSelected.totalDescuento | fixedNumber}} €</strong>
                </div>
                }
            </td>
        </ng-container>

        <!-- Importe -->
        <ng-container matColumnDef="importe">
            <th class="center"
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                sortActionDescription="Ordenar por importe">
                Importe
            </th>
            <td class="center"
                mat-cell
                *matCellDef="let element">
                {{element.importe | fixedNumber}} €
                @if (element.total !== element.importe) {
                <div class="original-price">{{element.total | fixedNumber}} €</div>
                }
            </td>
            <td class="center"
                mat-footer-cell
                *matFooterCellDef> <strong>{{ventaSelected.total | fixedNumber}} €</strong> </td>
        </ng-container>

        <tr mat-header-row
            *matHeaderRowDef="ventaSelectedDisplayedColumns"></tr>
        <tr mat-row
            *matRowDef="let row; columns: ventaSelectedDisplayedColumns;"></tr>
        <tr mat-footer-row
            *matFooterRowDef="ventaSelectedDisplayedColumns"></tr>
    </table>

</div>
}