<otpv-header selectedOption="compras"></otpv-header>

<mat-card class="pedido-header">
    <div class="pedido-header-bar">
        <button mat-icon-button
                title="Volver"
                type="button"
                routerLink="/compras">
            <mat-icon>chevron_left</mat-icon>
        </button>
        <span>{{titulo}}</span>
        <div class="actions"
             *ngIf="!pedido.recepcionado">
            <button mat-raised-button
                    color="primary"
                    (click)="guardar()">
                <mat-icon>save</mat-icon>
                Guardar
            </button>
            <button mat-raised-button
                    color="primary">
                <mat-icon>beenhere</mat-icon>
                Recepcionar
            </button>
        </div>
    </div>
</mat-card>

<mat-card class="pedido-main">
    <mat-card-content>
        <div class="pedido-options">
            <div class="row">
                <div class="form-field">
                    <label>Proveedor (*)</label>
                    <mat-form-field subscriptSizing="dynamic">
                        <mat-select [(ngModel)]="pedido.idProveedor"
                                    #proveedoresValue>
                            <mat-option [value]="-1">Elige proveedor</mat-option>
                            <mat-option *ngFor="let proveedor of ps.proveedores"
                                        [value]="proveedor.id">
                                {{proveedor.nombre}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                    <button mat-icon-button
                            title="Añadir nuevo proveedor"
                            type="button"
                            (click)="openProveedor()">
                        <mat-icon>add_circle_outline</mat-icon>
                    </button>
                </div>
                <div class="form-field re-ue">
                    <mat-checkbox *ngIf="config.tipoIva === 're'"
                                  [(ngModel)]="pedido.re">R.E.</mat-checkbox>
                    <mat-checkbox [(ngModel)]="pedido.ue">UE</mat-checkbox>
                </div>
                <div class="form-field">
                    <label>Fecha pedido</label>
                    <mat-form-field subscriptSizing="dynamic">
                        <input matInput
                               [matDatepicker]="fechaPedidoPicker"
                               [(ngModel)]="fechaPedido">
                        <mat-datepicker-toggle matSuffix
                                               [for]="fechaPedidoPicker"></mat-datepicker-toggle>
                        <mat-datepicker #fechaPedidoPicker></mat-datepicker>
                    </mat-form-field>
                </div>
                <div class="right-option">
                    <button mat-raised-button
                            color="primary"
                            type="button">
                        <mat-icon>add_circle_outline</mat-icon>
                        Crear nuevo artículo
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="form-field">
                    <label>Albarán / Factura</label>
                    <mat-form-field subscriptSizing="dynamic">
                        <mat-select [(ngModel)]="pedido.albaranFactura">
                            <mat-option value="albaran">Albarán</mat-option>
                            <mat-option value="factura">Factura</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-field">
                    <label>&nbsp;</label>
                    <mat-form-field subscriptSizing="dynamic">
                        <input matInput
                               placeholder="Número {{pedido.albaranFactura === 'albaran' ? 'albarán' : 'factura'}}"
                               [(ngModel)]="pedido.numAlbaranFactura"
                               #numAlbaranFacturaBox>
                    </mat-form-field>
                </div>
                <div class="form-field">
                    <label>Fecha pago</label>
                    <mat-form-field subscriptSizing="dynamic">
                        <input matInput
                               [matDatepicker]="fechaPagoPicker"
                               [(ngModel)]="fechaPago">
                        <mat-datepicker-toggle matSuffix
                                               [for]="fechaPagoPicker"></mat-datepicker-toggle>
                        <mat-datepicker #fechaPagoPicker></mat-datepicker>
                    </mat-form-field>
                </div>
                <div class="right-option">
                    <div class="form-field no-padding-right">
                        <label>Mostrar / ocultar columnas</label>
                        <mat-form-field subscriptSizing="dynamic">
                            <mat-select [(ngModel)]="colOptionsSelected"
                                        (selectionChange)="changeOptions()"
                                        multiple>
                                <ng-container *ngFor="let option of colOptions">
                                    <mat-option *ngIf="!option.default"
                                                [value]="option.id">{{option.value}}</mat-option>
                                </ng-container>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
            </div>
        </div>
        <div class="pedido-table">
            <table mat-table
                   [dataSource]="pedidoDataSource"
                   matSort
                   class="mat-elevation-z2 ">

                <!-- Localizador -->
                <ng-container matColumnDef="localizador">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por localizador">
                        Localizador
                    </th>
                    <td mat-cell
                        *matCellDef="let element"> {{element.localizador}} </td>
                </ng-container>

                <!-- Descripción -->
                <ng-container matColumnDef="descripcion">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por descripción">
                        Descripción
                    </th>
                    <td mat-cell
                        *matCellDef="let element">
                        <a [routerLink]="['/articulos', element.localizador, 'return', 'pedido']">{{element.descripcion}}</a>
                    </td>
                </ng-container>

                <!-- Marca -->
                <ng-container matColumnDef="marca">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por marca">
                        Marca
                    </th>
                    <td mat-cell
                        *matCellDef="let element"> {{element.marca}} </td>
                </ng-container>

                <!-- Referencia -->
                <ng-container matColumnDef="referencia">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por referencia">
                        Referencia
                    </th>
                    <td mat-cell
                        *matCellDef="let element"> {{element.referencia}} </td>
                </ng-container>

                <!-- Código barras -->
                <ng-container matColumnDef="codBarras">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por código barras">
                        Cod. Barras
                    </th>
                    <td mat-cell
                        *matCellDef="let element"> {{element.codBarras}} </td>
                </ng-container>

                <!-- Stock -->
                <ng-container matColumnDef="stock">
                    <th class="center"
                        mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por stock">
                        Stock
                    </th>
                    <td class="center"
                        mat-cell
                        *matCellDef="let element"> {{element.stock}} </td>
                </ng-container>

                <!-- Unidades -->
                <ng-container matColumnDef="unidades">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por unidades">
                        Unidades
                    </th>
                    <td mat-cell
                        *matCellDef="let element">
                        <mat-form-field class="campo-numero-small x-small"
                                        subscriptSizing="dynamic">
                            <input matInput
                                   placeholder="Unidades"
                                   type="number"
                                   id="tabla-unidades-{{element.localizador}}"
                                   (keydown)="checkArrows($event)"
                                   (focus)="$event.target.select()"
                                   [(ngModel)]="element.unidades">
                        </mat-form-field>
                    </td>
                </ng-container>

                <!-- Precio Albarán -->
                <ng-container matColumnDef="palb">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por precio albarán">
                        P. Alb.
                    </th>
                    <td mat-cell
                        *matCellDef="let element">
                        <mat-form-field class="campo-numero-small x-small"
                                        subscriptSizing="dynamic">
                            <input matInput
                                   placeholder="P. Alb."
                                   type="number"
                                   id="tabla-palb-{{element.localizador}}"
                                   (keydown)="checkArrows($event)"
                                   (focus)="$event.target.select()"
                                   [(ngModel)]="element.palb">
                        </mat-form-field>
                        €
                    </td>
                </ng-container>

                <!-- Subtotal -->
                <ng-container matColumnDef="subtotal">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por subtotal">
                        Subtotal
                    </th>
                    <td mat-cell
                        *matCellDef="let element"> {{element.subtotal | fixedNumber}} € </td>
                </ng-container>

                <!-- IVA -->
                <ng-container matColumnDef="iva">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por iva">
                        IVA
                    </th>
                    <td mat-cell
                        *matCellDef="let element">
                        <mat-form-field class="x-small"
                                        [title]="element.selectedIvaOption.name"
                                        subscriptSizing="dynamic">
                            <mat-select [(ngModel)]="element.selectedIvaOption.id"
                                        (ngModelChange)="updateIvaRe($event, element)">
                                <mat-option *ngFor="let iva of config.ivaOptions"
                                            [value]="iva.id">
                                    {{iva.name}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </td>
                </ng-container>

                <!-- Descuento -->
                <ng-container matColumnDef="descuento">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por descuento">
                        Descuento
                    </th>
                    <td mat-cell
                        *matCellDef="let element">
                        <mat-form-field class="campo-numero-small x-small"
                                        subscriptSizing="dynamic">
                            <input matInput
                                   placeholder="Descuento"
                                   type="number"
                                   id="tabla-descuento-{{element.localizador}}"
                                   (keydown)="checkArrows($event)"
                                   (focus)="$event.target.select()"
                                   [(ngModel)]="element.descuento">
                        </mat-form-field>
                        %
                    </td>
                </ng-container>

                <!-- PUC -->
                <ng-container matColumnDef="puc">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por PUC">
                        PUC
                    </th>
                    <td mat-cell
                        *matCellDef="let element"> {{element.puc | fixedNumber}} € </td>
                </ng-container>

                <!-- Total -->
                <ng-container matColumnDef="total">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por Total">
                        Total
                    </th>
                    <td mat-cell
                        *matCellDef="let element"> {{element.total | fixedNumber}} € </td>
                </ng-container>

                <!-- PVP -->
                <ng-container matColumnDef="pvp">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por PVP">
                        PVP
                    </th>
                    <td mat-cell
                        *matCellDef="let element">
                        <mat-form-field class="campo-numero-small x-small"
                                        subscriptSizing="dynamic">
                            <input matInput
                                   placeholder="PVP"
                                   type="number"
                                   id="tabla-pvp-{{element.localizador}}"
                                   (keydown)="checkArrows($event)"
                                   (focus)="$event.target.select()"
                                   [(ngModel)]="element.pvp">
                        </mat-form-field>
                        €
                    </td>
                </ng-container>

                <!-- Margen -->
                <ng-container matColumnDef="margen">
                    <th mat-header-cell
                        *matHeaderCellDef
                        mat-sort-header
                        sortActionDescription="Ordenar por Margen">
                        Margen
                    </th>
                    <td mat-cell
                        *matCellDef="let element"> {{element.margen | fixedNumber}} % </td>
                </ng-container>

                <!-- Borrar -->
                <ng-container matColumnDef="borrar">
                    <th class="center"
                        mat-header-cell
                        *matHeaderCellDef
                        sortActionDescription="Borrar">
                        Borrar
                    </th>
                    <td class="center"
                        mat-cell
                        *matCellDef="let element">
                        <button mat-icon-button
                                (click)="borrarLinea(element.localizador)">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row
                    *matHeaderRowDef="pedidoDisplayedColumns"></tr>
                <tr mat-row
                    *matRowDef="let row; columns: pedidoDisplayedColumns;"></tr>
            </table>
            <div class="nuevo-localizador-row">
                <mat-form-field class="remark small"
                                subscriptSizing="dynamic">
                    <input matInput
                           placeholder="Localizador"
                           type="number"
                           [(ngModel)]="nuevoLocalizador"
                           (keyup)="checkLocalizador($event)"
                           autocomplete="off"
                           (focus)="$event.target.select()"
                           #localizadorBox>
                </mat-form-field>
            </div>
        </div>
        <div class="pedido-footer">
            <div class="pedido-adjuntar">
                <label>Adjuntar PDFs</label>
                <div class="pdf-list">
                    <mat-list *ngIf="pedido.pdfs.length > 0">
                        <mat-list-item *ngFor="let item of pedido.pdfs; let i = index;">
                            <div class="row">
                                <span>{{item.nombre}}</span>
                                <button mat-icon-button
                                        (click)="deletePDF(i, item)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>
                        </mat-list-item>
                    </mat-list>
                    <div class="pdf-action">
                        <button mat-raised-button
                                color="primary"
                                (click)="addPDF()">
                            <mat-icon>attach_file</mat-icon>
                            Adjuntar PDF
                        </button>
                        <input type="file"
                               name="pdf-file"
                               id="pdf-file"
                               accept="application/pdf"
                               (change)="onPDFChange($event)">
                    </div>
                </div>
            </div>
            <div class="pedido-totales">
                <label>Totales</label>
                <div class="totales-box">
                    <div class="totales-col">
                        <div class="totales-row">
                            <span>Total líneas:</span>{{pedido.lineas.length}}
                        </div>
                        <div class="totales-row">
                            <span>Total artículos:</span>{{pedido.totalArticulos}}
                        </div>
                        <div class="totales-row">
                            <span>Total beneficios:</span>{{pedido.totalBeneficios | fixedNumber}} €
                        </div>
                        <div class="totales-row">
                            <span>Total PVP:</span>{{pedido.totalPVP | fixedNumber}} €
                        </div>
                        <div class="totales-row">
                            <span>Portes:</span>
                            <mat-form-field class="campo-numero-small x-small"
                                            subscriptSizing="dynamic">
                                <input matInput
                                       placeholder="Portes"
                                       type="number"
                                       (focus)="$event.target.select()"
                                       autocomplete="off"
                                       [(ngModel)]="pedido.portes">
                            </mat-form-field>
                            €
                        </div>
                        <div class="totales-row">
                            <span>Media margen:</span>28 %
                        </div>
                    </div>
                    <div class="totales-col">
                        <div class="totales-row">
                            <span>Subtotal:</span>{{pedido.subtotal | fixedNumber}} €
                        </div>
                        <div class="totales-row totales-iva-row">
                            <ng-container *ngFor="let ivaOption of pedido.ivaList">
                                <div class="iva-row"
                                     *ngIf="ivaOption.iva !== undefined || ivaOption.re !== undefined">
                                    <ng-container *ngIf="ivaOption.iva !== undefined">
                                        <div class="iva-col">IVA {{ivaOption.ivaOption}}%</div>
                                        <div class="iva-col"
                                             [ngClass]="{'iva-center': ivaOption.re !== undefined, 'iva-num': ivaOption.re === undefined}">
                                            {{ivaOption.iva | fixedNumber}} €
                                        </div>
                                    </ng-container>
                                    <ng-container *ngIf="ivaOption.re !== undefined">
                                        <div class="iva-col">R.E. {{ivaOption.reOption}}%</div>
                                        <div class="iva-col iva-num">{{ivaOption.re | fixedNumber}} €</div>
                                    </ng-container>
                                </div>
                            </ng-container>
                        </div>
                        <div class="totales-row mark">
                            <span>Total {{pedido.albaranFactura === 'albaran' ? 'albarán' : 'factura'}}:</span>{{pedido.total | fixedNumber}} €
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </mat-card-content>
</mat-card>

<otpv-new-proveedor (savedEvent)="proveedorGuardado($event)"
                    #newProveedor></otpv-new-proveedor>